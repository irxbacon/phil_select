{% extends "base.html" %}

{% block title %}Results - Philmont Trek Selection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-trophy"></i> Trek Selection Results</h2>
        <p class="lead">Ranked itineraries based on your crew's preferences and program scores.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Understanding Your Results</h5>
            <div class="row">
                <div class="col-md-4">
                    <h6>Score Components:</h6>
                    <ul class="mb-0">
                        <li><strong>Program:</strong> Based on your activity preferences and program factor</li>
                        <li><strong>Difficulty:</strong> Matches your accepted difficulty levels</li>
                        <li><strong>Area:</strong> Regional preferences (if area is important)</li>
                        <li><strong>Altitude:</strong> Altitude thresholds and preferences</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Difficulty Levels:</h6>
                    <ul class="mb-0">
                        <li><span class="badge difficulty-C">C</span> Challenging</li>
                        <li><span class="badge difficulty-R">R</span> Rugged</li>
                        <li><span class="badge difficulty-S">S</span> Strenuous</li>
                        <li><span class="badge difficulty-SS">SS</span> Super Strenuous</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Region Icons:</h6>
                    <ul class="mb-0">
                        <li><i class="fas fa-sun text-warning"></i> South Country</li>
                        <li><i class="fas fa-mountain text-primary"></i> Central Country</li>
                        <li><i class="fas fa-snowflake text-info"></i> North Country</li>
                        <li><i class="fas fa-tree text-success"></i> Valle Vidal</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calculator"></i> Calculation Method
            </div>
            <div class="card-body">
                <form method="GET" class="d-inline">
                    <div class="input-group">
                        <select name="method" class="form-select" onchange="this.form.submit()">
                            <option value="Total" {% if calculation_method == 'Total' %}selected{% endif %}>Total Score</option>
                            <option value="Average" {% if calculation_method == 'Average' %}selected{% endif %}>Average Score</option>
                            <option value="Median" {% if calculation_method == 'Median' %}selected{% endif %}>Median Score</option>
                            <option value="Mode" {% if calculation_method == 'Mode' %}selected{% endif %}>Mode Score</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </form>
                <small class="text-muted">
                    Using: <strong>{{ calculation_method }}</strong> method
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-medal"></i> Top Choices
            </div>
            <div class="card-body">
                {% if results %}
                    {% for result in results[:3] %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-3">
                            {% if loop.index == 1 %}
                                <i class="fas fa-medal text-warning fa-lg"></i>
                            {% elif loop.index == 2 %}
                                <i class="fas fa-medal text-secondary fa-lg"></i>
                            {% else %}
                                <i class="fas fa-medal text-danger fa-lg"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong>{{ result.itinerary.itinerary_code }}</strong>
                            <span class="badge difficulty-{{ result.itinerary.difficulty|difficulty_class }}">{{ result.itinerary.difficulty|difficulty_abbrev }}</span>
                            <br>
                            <small class="text-muted">Score: 
                                <span title="Program: {{ '%.0f'|format(result.components.program_score) }}&#10;Difficulty: {{ '%.0f'|format(result.components.difficulty_score) }}&#10;Area: {{ '%.0f'|format(result.components.area_score) }}&#10;Altitude: {{ '%.0f'|format(result.components.altitude_score) }}&#10;Distance: {{ '%.0f'|format(result.components.distance_score) }}&#10;Hike: {{ '%.0f'|format(result.components.hike_score) }}&#10;Camp: {{ '%.0f'|format(result.components.camp_score) }}&#10;Peak: {{ '%.0f'|format(result.components.peak_score) }}">{{ "%.0f"|format(result.total_score) }}</span>
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No itineraries available for the selected trek type yet. Coming soon!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> All Itineraries</span>
                <div>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="toggleComponentScores()" id="toggleScoresBtn">
                        <i class="fas fa-eye"></i> <span id="toggleScoresText">Show Scores</span>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if results %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2">Rank</th>
                                <th colspan="3">Itinerary Details</th>
                                <th rowspan="2">Total Score</th>
                                <th colspan="5" class="component-scores-header" style="display: none;">Component Scores</th>
                                <th rowspan="2">Actions</th>
                            </tr>
                            <tr>
                                <th>Code</th>
                                <th>Difficulty</th>
                                <th>Distance</th>
                                <th class="component-scores-header" style="display: none;">Program Score</th>
                                <th class="component-scores-header" style="display: none;">Difficulty Score</th>
                                <th class="component-scores-header" style="display: none;">Area Score</th>
                                <th class="component-scores-header" style="display: none;">Altitude Score</th>
                                <th class="component-scores-header" style="display: none;">Distance Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr {% if loop.index <= 3 %}class="table-warning"{% endif %}>
                                <td>
                                    <strong>{{ result.ranking }}</strong>
                                    {% if loop.index == 1 %}
                                        <i class="fas fa-crown text-warning ms-1"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('program_routes.itinerary_detail', code=result.itinerary.itinerary_code) }}" class="text-decoration-none">
                                        <strong>{{ result.itinerary.itinerary_code }}</strong>
                                    </a>
                                    {% if result.itinerary.covers_south %}<i class="fas fa-sun text-warning" title="South Country"></i>{% endif %}
                                    {% if result.itinerary.covers_central %}<i class="fas fa-mountain text-primary" title="Central Country"></i>{% endif %}
                                    {% if result.itinerary.covers_north %}<i class="fas fa-snowflake text-info" title="North Country"></i>{% endif %}
                                    {% if result.itinerary.covers_valle_vidal %}<i class="fas fa-tree text-success" title="Valle Vidal"></i>{% endif %}
                                </td>
                                <td>
                                    <span class="badge difficulty-{{ result.itinerary.difficulty|difficulty_class }}">
                                        {{ result.itinerary.difficulty|difficulty_abbrev }}
                                    </span>
                                </td>
                                <td>{{ result.itinerary.distance or 'N/A' }} mi</td>
                                <td>
                                    <strong title="Program: {{ '%.0f'|format(result.components.program_score) }}&#10;Difficulty: {{ '%.0f'|format(result.components.difficulty_score) }}&#10;Area: {{ '%.0f'|format(result.components.area_score) }}&#10;Altitude: {{ '%.0f'|format(result.components.altitude_score) }}&#10;Distance: {{ '%.0f'|format(result.components.distance_score) }}&#10;Hike: {{ '%.0f'|format(result.components.hike_score) }}&#10;Camp: {{ '%.0f'|format(result.components.camp_score) }}&#10;Peak: {{ '%.0f'|format(result.components.peak_score) }}">{{ "%.0f"|format(result.total_score) }}</strong>
                                </td>
                                <td class="component-scores-cell" style="display: none;">{{ "%.0f"|format(result.components.program_score) }}</td>
                                <td class="component-scores-cell" style="display: none;">{{ "%.0f"|format(result.components.difficulty_score) }}</td>
                                <td class="component-scores-cell" style="display: none;">{{ "%.0f"|format(result.components.area_score) }}</td>
                                <td class="component-scores-cell" style="display: none;">{{ "%.0f"|format(result.components.altitude_score) }}</td>
                                <td class="component-scores-cell" style="display: none;">{{ "%.0f"|format(result.components.distance_score) }}</td>
                                <td>
                                    <a href="{{ url_for('program_routes.itinerary_detail', code=result.itinerary.itinerary_code) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info m-3">
                    <h5><i class="fas fa-info-circle"></i> No Itineraries Available</h5>
                    <p>There are currently no itineraries available for the selected trek type. Data for 7-Day and Cavalcade treks is coming soon!</p>
                    <p>Try selecting a different trek type in your <a href="{{ url_for('base_routes.preferences') }}" class="alert-link">preferences</a>.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Understanding Your Results</h5>
            <div class="row">
                <div class="col-md-4">
                    <h6>Score Components:</h6>
                    <ul class="mb-0">
                        <li><strong>Program:</strong> Based on your activity preferences and program factor</li>
                        <li><strong>Difficulty:</strong> Matches your accepted difficulty levels</li>
                        <li><strong>Area:</strong> Regional preferences (if area is important)</li>
                        <li><strong>Altitude:</strong> Altitude thresholds and preferences</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Difficulty Levels:</h6>
                    <ul class="mb-0">
                        <li><span class="badge difficulty-C">C</span> Challenging</li>
                        <li><span class="badge difficulty-R">R</span> Rugged</li>
                        <li><span class="badge difficulty-S">S</span> Strenuous</li>
                        <li><span class="badge difficulty-SS">SS</span> Super Strenuous</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Region Icons:</h6>
                    <ul class="mb-0">
                        <li><i class="fas fa-sun text-warning"></i> South Country</li>
                        <li><i class="fas fa-mountain text-primary"></i> Central Country</li>
                        <li><i class="fas fa-snowflake text-info"></i> North Country</li>
                        <li><i class="fas fa-tree text-success"></i> Valle Vidal</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('scoring_routes.scores') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Scores
            </a>
            <a href="{{ url_for('program_routes.program_chart', method=calculation_method) }}" class="btn btn-outline-info">
                <i class="fas fa-chart-bar"></i> Program Chart
            </a>
            <button class="btn btn-success" onclick="window.print()">
                <i class="fas fa-print"></i> Print Results
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function exportResults() {
        // Simple CSV export
        let csv = 'Rank,Itinerary,Difficulty,Distance,Total Score,Program Score,Difficulty Score,Area Score,Altitude Score,Distance Score\n';
        
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rank = cells[0].textContent.trim().replace('ðŸ‘‘', '').trim();
            const itinerary = cells[1].textContent.trim().split('\n')[0];
            const difficulty = cells[2].textContent.trim();
            const distance = cells[3].textContent.trim().replace(' mi', '');
            const totalScore = cells[4].textContent.trim();
            const programScore = cells[5].textContent.trim();
            const difficultyScore = cells[6].textContent.trim();
            const areaScore = cells[7].textContent.trim();
            const altitudeScore = cells[8].textContent.trim();
            const distanceScore = cells[9].textContent.trim();
            
            csv += `${rank},"${itinerary}","${difficulty}","${distance}",${totalScore},${programScore},${difficultyScore},${areaScore},${altitudeScore},${distanceScore}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'philmont_results.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Auto-refresh every 30 seconds if user is actively scoring
    let autoRefresh = false;
    
    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        if (autoRefresh) {
            const interval = setInterval(() => {
                if (!autoRefresh) {
                    clearInterval(interval);
                    return;
                }
                
                // Refresh results
                fetch(`/api/calculate?method={{ calculation_method }}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Results updated');
                        // Could update the table dynamically here
                    })
                    .catch(err => console.error('Auto-refresh failed:', err));
            }, 30000);
        }
    }
    
    function toggleComponentScores() {
        const headers = document.querySelectorAll('.component-scores-header');
        const cells = document.querySelectorAll('.component-scores-cell');
        const btn = document.getElementById('toggleScoresBtn');
        const btnText = document.getElementById('toggleScoresText');
        const btnIcon = btn.querySelector('i');
        
        const isHidden = headers[0].style.display === 'none';
        
        headers.forEach(header => {
            header.style.display = isHidden ? '' : 'none';
        });
        
        cells.forEach(cell => {
            cell.style.display = isHidden ? '' : 'none';
        });
        
        if (isHidden) {
            btnText.textContent = 'Hide Scores';
            btnIcon.className = 'fas fa-eye-slash';
        } else {
            btnText.textContent = 'Show Scores';
            btnIcon.className = 'fas fa-eye';
        }
    }
</script>

<style>
    @media print {
        .btn, .card-header button, .alert {
            display: none !important;
        }
        
        .table {
            font-size: 0.8em;
        }
        
        .badge:not([class*="difficulty-"]) {
            border: 1px solid #000 !important;
            color: #000 !important;
            background: #fff !important;
        }
        
        /* Keep difficulty badge colors in print but add borders for clarity */
        .badge[class*="difficulty-"] {
            border: 1px solid #000 !important;
        }
    }
</style>
{% endblock %}